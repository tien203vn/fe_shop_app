

<app-header></app-header>
<div id="breadcrumbs" class="breadcrumbs">
  <div class="container">

    <div class="d-flex justify-content-between align-items-center">
      <h2>Gi·ªè h√†ng</h2>
      <ol>
        <li><a routerLink="/">Trang ch·ªß</a></li>
        <li><a >Gi·ªè h√†ng</a></li>
        <li>Chi ti·∫øt gi·ªè h√†ng</li>
      </ol>
    </div>
  </div>
</div>
<div class="container" style="margin-top: 30px;">
  

  <div class="row">
    <div class="col-xl-8">

      <div class="card">
        <div class="card-body">
          <ol class="activity-checkout mb-0 px-4 mt-3">
            <form [formGroup]="orderForm">
            <li class="checkout-item">
              <div class="avatar checkout-icon p-1">
                <div class="avatar-title rounded-circle bg-primary" style="background-color: #d63384 !important;">
                  <i class="fa-solid fa-circle-info"></i>
                </div>
              </div>
              <div class="feed-item-list">
                <div>
                  <h5 class="font-size-16 mb-1">Th√¥ng tin ng∆∞·ªùi nh·∫≠n</h5>
                  <p class="text-muted text-truncate mb-4">ƒêi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin</p>
                  <div class="mb-3">
                    
                      <div>
                        <div class="row">
                          <div class="col-lg-4">
                            <div class="mb-3">
                              <label class="form-label" for="fullname">H·ªç v√† t√™n</label>
                              <input type="text" class="form-control" id="fullname" formControlName="fullname"
                                placeholder="Nh·∫≠p t√™n"
                                [class.is-invalid]="orderForm.get('fullname')!.invalid && orderForm.get('fullname')!.touched">
                              <div *ngIf="orderForm.get('fullname')!.invalid && orderForm.get('fullname')!.touched"
                                class="invalid-feedback">
                                H·ªç v√† t√™n l√† tr∆∞·ªùng b·∫Øt bu·ªôc.
                              </div>

                            </div>
                          </div>
                          <div class="col-lg-4">
                            <div class="mb-3">
                              <label class="form-label" for="email">Email</label>
                              <input type="email" class="form-control" id="email" formControlName="email"
                                placeholder="Nh·∫≠p email"
                                [class.is-invalid]="orderForm.get('email')!.invalid && orderForm.get('email')!.touched ">
                              <div *ngIf="orderForm.get('email')!.invalid && orderForm.get('email')!.touched"
                                class="invalid-feedback">
                                {{ orderForm.get('email')!.hasError('email') ? 'Email kh√¥ng h·ª£p l·ªá' : 'Email l√† tr∆∞·ªùng b·∫Øt bu·ªôc' }}
                              </div>
                            </div>
                          </div>
                          <div class="col-lg-4">
                            <div class="mb-3">
                              <label class="form-label" for="phone">Phone</label>
                              <input type="text" class="form-control" id="phone" formControlName="phone_number"
                                placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                                [class.is-invalid]="orderForm.get('phone_number')!.invalid && orderForm.get('phone_number')!.touched">
                              <div
                                *ngIf="orderForm.get('phone_number')!.invalid && orderForm.get('phone_number')!.touched"
                                class="invalid-feedback">
                                S·ªë ƒëi·ªán tho·∫°i l√† tr∆∞·ªùng b·∫Øt bu·ªôc v√† √≠t nh·∫•t 6 k√Ω t·ª±.
                              </div>

                            </div>
                          </div>
                        </div>

                        <div class="mb-3">
                          <label class="form-label" for="address">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</label>
                          <textarea class="form-control" id="address" rows="3" formControlName="address"
                            placeholder="Nh·∫≠p th√¥ng tin nh·∫≠n h√†ng"
                            [class.is-invalid]="orderForm.get('address')!.invalid && orderForm.get('address')!.touched">
                          </textarea>
                          <div *ngIf="orderForm.get('address')!.invalid && orderForm.get('address')!.touched"
                            class="invalid-feedback">
                            ƒê·ªãa ch·ªâ l√† tr∆∞·ªùng b·∫Øt bu·ªôc v√† √≠t nh·∫•t 5 k√Ω t·ª±.
                          </div>
                        </div>

                        <div class="mb-3">
                          <label class="form-label" for="note">Ghi ch√∫</label>
                          <textarea class="form-control" id="note" rows="2" formControlName="note"
                            placeholder="Nh·∫≠p ghi ch√∫ mong mu·ªën"></textarea>
                        </div>
                        <div class="mb-2" style="height: 50px;" >
                          <div class="input-group" >
                            <select style="width: 500px;" class="form-control" formControlName="couponCode">
                              <option value="" disabled>Ch·ªçn m√£ gi·∫£m gi√°</option>
                              <option *ngFor="let coupon of coupons" [value]="coupon.code">{{ coupon.code }}</option>
                            </select>
                              <button type="submit" class="btn btn-primary font-size-16" (click)="applyCoupon()">√Åp d·ª•ng</button>
                          </div>                  
                        </div>
                        <div *ngIf="couponDiscount > 0" class="text-start mt-3">
                          <h6 class="header-text text-end">B·∫°n ƒë∆∞·ª£c gi·∫£m: {{ couponDiscount | number:'1.0-0' }} ƒë
                          </h6>
                        </div>
                      </div>
                    
                  </div>
                </div>
              </div>
            </li>
                       
            <li class="checkout-item">
              <div class="avatar checkout-icon p-1">
                <div class="avatar-title rounded-circle bg-primary" style="background-color: #d63384 !important;">
                  <i class="fa-solid fa-truck"></i>
                </div>
              </div>
              <div class="feed-item-list">
                <div>
                  <h5 class="font-size-16 mb-1" for="shippingMethod">Th√¥ng tin v·∫≠n chuy·ªÉn</h5>
                  <p class="text-muted text-truncate mb-4"> Ch·ªçn th√¥ng tin</p>
                  <div class="mb-3">
                    <select class="form-select" id="shippingMethod" formControlName="shipping_method">
                      <option value="express" [selected]="true">Nhanh (Express)</option>
                      <option value="normal">Th∆∞·ªùng (Normal)</option>
                    </select>
                  </div>
                </div>
              </div>

            </li>
            <li class="checkout-item">
              <div class="avatar checkout-icon p-1">
                <div class="avatar-title rounded-circle bg-primary" style="background-color: #d63384 !important;">
                  <i class="fa-solid fa-money-check-dollar"></i>
                </div>
              </div>
              <div class="feed-item-list">
                <div>
                  <h5 class="font-size-16 mb-1">Ph∆∞∆°ng th·ª©c thanh to√°n</h5>
                  <p class="text-muted text-truncate mb-4">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</p>
                </div>
                <div>
                  <select class="form-select" id="paymentMethod" formControlName="payment_method">
                    <option value="other" selected>Thanh to√°n tr·ª±c tuy·∫øn</option>
                    <option value="cod">Thanh to√°n khi nh·∫≠n h√†ng (COD)</option>
                  </select>
                </div>
              </div>
            </li>
          </form>
          </ol>
        </div>
      </div>

      <div class="row my-4">
        <div class="col">
          <a routerLink="/product-list" class="btn btn-link text-muted">
            <i class="mdi mdi-arrow-left me-1"></i> Ti·∫øp t·ª•c mua h√†ng </a>
        </div> <!-- end col -->
        <div class="col">
          <div class="text-end mt-2 mt-sm-0">
            <!-- Hi·ªÉn th·ªã loading khi ƒëang t·∫°o payment link -->
            <div *ngIf="isCreatingPaymentLink" class="text-center p-3">
              <div class="spinner-border text-primary" aria-label="Loading">
                <span class="visually-hidden">ƒêang t·∫°o link thanh to√°n...</span>
              </div>
              <div class="mt-2">ƒêang t·∫°o link thanh to√°n...</div>
            </div>
            
            <!-- Button ƒë·∫∑t h√†ng -->
            <a *ngIf="!isPaymentOpen && !isCreatingPaymentLink" 
               (click)="placeOrder()" 
               class="btn btn-success">
              <i class="mdi mdi-cart-outline me-1"></i> ƒê·∫∑t h√†ng
            </a>
            
            <!-- Button ƒë√≥ng PayOS checkout -->
            <button *ngIf="isPaymentOpen" 
                    class="btn btn-secondary"
                    (click)="closePayment()">
              <i class="mdi mdi-close me-1"></i> ƒê√≥ng thanh to√°n
            </button>
          </div>
        </div> <!-- end col -->
      </div> <!-- end row-->
    </div>
    <div class="col-xl-4">
      <div class="card checkout-order-summary">
        <div class="card-body">
          <div class="p-3 bg-light mb-3">
            <h5 class="font-size-16 mb-0">S·∫£n ph·∫©m ƒë√£ ƒë·∫∑t </h5>
          </div>
          <div class="table-responsive">
            <table class="table table-centered mb-0 table-nowrap">
              <thead>
                <tr>
                  <th class="border-top-0" style="width: 110px;" scope="col">H√¨nh ·∫£nh</th>
                  <th class="border-top-0" scope="col">S·∫£n ph·∫©m</th>
                  <th class="border-top-0" scope="col">Gi√°</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let item of cartItems; let i = index">
                  <tr>
                    <th scope="row"><img [src]="item.product.displayImageUrl" 
                           alt="{{ item.product.name }}" 
                           title="{{ item.product.name }}"
                           class="avatar-lg rounded"
                           (error)="handleImageError($event)"></th>
                    <td>
                      <h5 class="font-size-16 text-truncate"><a class="text-dark">{{ item.product.name }}</a></h5>
                      <p class="text-muted mb-0">
                        <i class="bx bxs-star text-warning"></i>
                        <i class="bx bxs-star text-warning"></i>
                        <i class="bx bxs-star text-warning"></i>
                        <i class="bx bxs-star text-warning"></i>
                        <i class="bx bxs-star-half text-warning"></i>
                      </p>
                      <p class="text-muted mb-0 mt-1">{{item.product.price | number:'1.0-0'}} </p>
                      <div class="product-quantity">
                        <div class="border-wrapper quantity-controls">
                          <button style="margin-right: 2px;" (click)="decreaseQuantity(i)"><i class="fa-solid fa-minus"></i></button>
                          {{ item.quantity }}
                          <button style="margin-left: 2px;" (click)="increaseQuantity(i)"><i class="fa-solid fa-plus"></i></button>
                        </div>
                      </div>
                    </td>
                    <td>{{ (item.product.price * item.quantity) | number:'1.0-0' }}</td>
                    <td>
                      <button style="font-size: 13px;" class="btn btn-danger" (click)="removeFromCart(i)">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </td>
                  </tr>

                </ng-container>

                <tr class="bg-light">
                  <td colspan="2">
                    <h5 class="font-size-14 m-0">T·ªïng:</h5>
                  </td>
                  <td>
                    {{totalAmount | number:'1.0-0'}}
                  </td>
                </tr>
              </tbody>
            </table>


          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- end row -->

  <!-- PayOS Embedded Checkout Container -->
  <div class="row mt-4" *ngIf="isPaymentOpen">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Thanh to√°n qua PayOS</h5>
          <div class="alert alert-info">
            Sau khi th·ª±c hi·ªán thanh to√°n th√†nh c√¥ng, vui l√≤ng ƒë·ª£i t·ª´ 5 - 10s ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông c·∫≠p nh·∫≠t.
          </div>
          
          <!-- PayOS Container -->
          <div id="embedded-payment-container" 
               style="display: none; min-height: 100px; border: 1px dashed #ccc; padding: 10px; background: #f8f9fa; border-radius: 8px;">
            <p style="color: #999; text-align: center; margin: 0;">PayOS s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
          </div>
          
          <!-- Debug button ƒë·ªÉ test -->
          <!-- <div class="text-center mt-2 mb-3">
            <button (click)="testPayOSDisplay()" class="btn btn-info btn-sm">
              üîç Test PayOS Display
            </button>
          </div> -->
          
          <!-- N√∫t ƒë√≥ng thanh to√°n khi ƒëang hi·ªÉn th·ªã -->
          <div *ngIf="isPaymentOpen" class="text-center mt-3">
            <button (click)="closePayment()" class="btn btn-secondary">
              ƒê√≥ng thanh to√°n
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Th√¥ng b√°o thanh to√°n th√†nh c√¥ng -->
  <div class="row mt-4" *ngIf="paymentMessage">
    <div class="col-12">
      <div class="alert alert-success text-center">
        <h4>{{ paymentMessage }}</h4>
        <p>ƒêang chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß...</p>
      </div>
    </div>
  </div>

</div>

<app-footer></app-footer> 

